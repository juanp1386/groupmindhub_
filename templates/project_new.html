{% extends 'base.html' %}
{% block content %}
<h1>Create Project</h1>
<form method="post" id="projectForm" style="display:flex;flex-direction:column;gap:14px;max-width:760px;">{% csrf_token %}
  <input type="hidden" name="sections_json" id="sectionsJson" />
  <input type="hidden" name="sim_user" id="simUserHidden" />
  <label>Name<br><input name="name" required placeholder="e.g., Community Garden Bylaws" style="width:100%;"/></label>
  <label>Description<br><textarea name="description" rows="2" placeholder="Short description" style="width:100%;"></textarea></label>
  <div>
    <h3 style="margin:4px 0 8px;">Sections</h3>
    <div id="sectionsContainer" style="display:flex;flex-direction:column;gap:12px;"></div>
    <div style="display:flex;gap:12px;align-items:center;margin-top:8px;">
      <button type="button" id="addRootSectionBtn">➕ Add Top-Level Section</button>
      <span class="muted" style="font-size:11px;">Sections may be nested arbitrarily. Use the controls on each section to add/remove/reorder.</span>
    </div>
  </div>
  <div><button>Create Project</button></div>
</form>
<script>
(function(){
  const key='gmh_sim_user';
  const sim=localStorage.getItem(key)||'';
  const simHidden=document.getElementById('simUserHidden');
  if(simHidden) simHidden.value=sim;

  const container=document.getElementById('sectionsContainer');
  const addRootBtn=document.getElementById('addRootSectionBtn');
  if(!container||!addRootBtn){console.warn('Section builder init skipped (elements missing)');return;}

  const sections=[];

  const uuid=()=> (window.crypto && crypto.randomUUID ? crypto.randomUUID() : `tmp_${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`);
  const escapeHtml=s=>s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

  function ensureChildren(node){if(!Array.isArray(node.children)) node.children=[];}

  function newSection(){
    return {id:uuid(),heading:'',body:'',children:[]};
  }

  function getContext(path){
    let list=sections;
    let node=null;
    for(let i=0;i<path.length;i++){
      const idx=path[i];
      node=list[idx];
      if(i===path.length-1){
        return {list,index:idx,node};
      }
      ensureChildren(node);
      list=node.children;
    }
    return {list:sections,index:null,node:null};
  }

  function numberingFromPath(path){
    return path.map(i=>i+1).join('.');
  }

  function render(){
    container.innerHTML='';
    if(sections.length===0){
      const empty=document.createElement('div');
      empty.className='muted';
      empty.textContent='Add at least one section to get started.';
      container.appendChild(empty);
      return;
    }
    const frag=document.createDocumentFragment();
    const renderList=(list,pathPrefix,depth,wrap)=>{
      list.forEach((section,idx)=>{
        ensureChildren(section);
        const path=pathPrefix.concat(idx);
        const number=numberingFromPath(path);
        const card=document.createElement('div');
        card.className='card';
        card.style.padding='12px';
        card.style.marginLeft=`${depth*16}px`;
        card.setAttribute('data-path',path.join('|'));
        card.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
          <strong style="font-size:14px;">Section ${number}</strong>
          <div style="display:flex;gap:4px;flex-wrap:wrap;justify-content:flex-end;">
            <button type="button" data-act="add-child" style="font-size:10px;">➕ Subsection</button>
            <button type="button" data-act="up" style="font-size:10px;" ${idx===0?'disabled':''}>▲</button>
            <button type="button" data-act="down" style="font-size:10px;" ${idx===list.length-1?'disabled':''}>▼</button>
            <button type="button" data-act="remove" style="font-size:10px;color:#f88;">✖</button>
          </div>
        </div>
        <label style="display:block;margin-top:6px;font-size:12px;">Heading<br><input data-field="heading" value="${escapeHtml(section.heading)}" style="width:100%;" placeholder="Heading"/></label>
        <label style="display:block;margin-top:6px;font-size:12px;">Body<br><textarea data-field="body" rows="3" style="width:100%;" placeholder="Body (optional)">${escapeHtml(section.body)}</textarea></label>`;
        card.querySelectorAll('input,textarea').forEach(inp=>{
          inp.addEventListener('input',()=>{
            section[inp.getAttribute('data-field')]=inp.value;
          });
        });
        card.querySelectorAll('button[data-act]').forEach(btn=>{
          btn.addEventListener('click',()=>{
            const {list:ctxList,index}=getContext(path);
            if(ctxList && index!==null){
              const act=btn.getAttribute('data-act');
              if(act==='remove'){
                ctxList.splice(index,1);
              }else if(act==='up' && index>0){
                [ctxList[index-1],ctxList[index]]=[ctxList[index],ctxList[index-1]];
              }else if(act==='down' && index<ctxList.length-1){
                [ctxList[index+1],ctxList[index]]=[ctxList[index],ctxList[index+1]];
              }else if(act==='add-child'){
                ensureChildren(section);
                section.children.push(newSection());
              }
              render();
            }
          });
        });
        wrap.appendChild(card);
        if(section.children.length){
          renderList(section.children,path,depth+1,wrap);
        }
      });
    };
    renderList(sections,[],0,frag);
    container.appendChild(frag);
  }

  addRootBtn.addEventListener('click',()=>{
    sections.push(newSection());
    render();
    requestAnimationFrame(()=>{
      const last=container.lastElementChild; if(last){ last.scrollIntoView({behavior:'smooth',block:'center'}); }
    });
  });

  document.getElementById('projectForm').addEventListener('submit',()=>{
    document.getElementById('sectionsJson').value=JSON.stringify(sections);
  });

  sections.push({id:uuid(),heading:'Purpose',body:'',children:[]});
  render();
})();
</script>
<style>
@keyframes fadeBorder { 0%{outline-color:#4aa;} 80%{outline-color:rgba(74,170,170,0);} 100%{outline:none;} }
</style>
{% endblock %}
