{% load static %}
<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ entry.title }} – GroupMindHub Entry</title>
  <link id="siteFavicon" rel="icon" type="image/png" href="{% static 'img/favicon-light.png' %}" />
  <link rel="stylesheet" href="{% static 'css/global.css' %}" />
  <link rel="stylesheet" href="{% static 'css/entry.css' %}" />

</head>
<body class="entry-page">
  <header>
    <div class="wrap site-head">
      <div class="brand">
        <a href="/">
          <img class="brand-logo brand-logo-light" src="{% static 'img/logo-light.png' %}" alt="GroupMindHub" />
          <img class="brand-logo brand-logo-dark" src="{% static 'img/logo-dark.png' %}" alt="GroupMindHub" />
        </a>
      </div>
      <button type="button" class="nav-toggle" id="navToggle" aria-label="Toggle navigation" aria-expanded="false" aria-controls="headControls">
        <span class="sr-only">Toggle navigation</span>
        <span class="nav-toggle-icon" aria-hidden="true"></span>
      </button>
      <div class="head-controls" id="headControls" data-expanded="false">
        <div class="head-links">
          <a href="/" class="pill">Home</a>
          <a href="/updates/" class="pill">Updates</a>
          {% if project_membership and project_membership.is_owner %}
          <a href="{% url 'project_settings' entry.project.id %}" class="pill">Settings</a>
          {% endif %}
        </div>
        <button type="button" id="themeToggle" class="theme-toggle" aria-label="Toggle theme">
          <span class="toggle-track"><span class="toggle-thumb"></span></span>
          <span class="toggle-label" id="themeToggleLabel">Light</span>
        </button>
        {% if user.is_authenticated %}
        <div class="user-panel">
          {% with user.get_full_name|default:user.get_username as display_name %}
          <div class="user-chip">
            <span class="user-avatar">{{ display_name|slice:':1'|upper }}</span>
            <span class="user-meta">
              <span class="user-name">{{ display_name }}</span>
              {% if project_membership %}
                <span class="user-role">{{ project_membership.get_role_display }}</span>
              {% else %}
                <span class="user-role">Signed in</span>
              {% endif %}
            </span>
            <form method="post" action="{% url 'logout' %}" class="logout-form">
              {% csrf_token %}
              <button type="submit">Logout</button>
            </form>
          </div>
          {% endwith %}
        </div>
        {% else %}
        <div class="auth-links">
          <a href="{% url 'login' %}?next={{ request.path|urlencode }}">Login</a>
          <a href="{% url 'signup' %}?next={{ request.path|urlencode }}">Sign up</a>
        </div>
        {% endif %}
      </div>
    </div>
  </header>
  <main class="wrap">
    <script type="application/json" id="__entry_json">{{ ENTRY_JSON|safe }}</script>
    {% if user_payload %}{{ user_payload|json_script:"__gmh_user" }}{% endif %}
    <section class="project-banner">
      <div>
        <h1>{{ entry.project.name }}</h1>
        {% if entry.project.description %}
        <p>{{ entry.project.description }}</p>
        {% else %}
        <p class="muted-small">No project description provided yet.</p>
        {% endif %}
      </div>
    </section>
    <div class="workspace-toolbar">
      <div class="pane-title">Workspace</div>
      <div class="controls pane-controls">
        <button class="ghost" type="button" data-pane-max="doc" aria-pressed="false">Max doc</button>
        <button class="ghost" type="button" data-pane-max="candidates" aria-pressed="false">Max candidates</button>
        <button class="ghost" type="button" data-pane-max="editor" aria-pressed="false">Max editor</button>
        <button class="ghost" data-pane-layout-reset>Reset layout</button>
      </div>
    </div>
    <div class="workspace-shell" id="workspaceShell" aria-label="GroupMindHub workspace">
      <div class="workspace-pane" data-pane="doc" data-pane-key="doc">
        <section class="card entry-card">
          <div class="hd">
            <div>
              <div class="pane-title">Active document</div>
              <div class="row" style="margin-top:6px;gap:10px;flex-wrap:wrap;">
                <span class="pill">Version <span id="entryVersion2"></span></span>
                <span class="pill">Votes <span id="entryVotes2"></span></span>
              </div>
            </div>
            <div class="pane-controls">
              <button class="primary" id="btnAddSection" aria-label="Add section">Add section</button>
              <button class="ghost" type="button" data-pane-max="doc" aria-label="Maximize active document" aria-pressed="false">Maximize</button>
            </div>
          </div>
          <div class="bd">
            <div class="outline-toolbar" role="toolbar" aria-label="Document outline controls">
              <div class="outline-toggles" role="group" aria-label="Outline display">
                <button type="button" class="outline-toggle" data-outline-mode="expanded" aria-pressed="false">Expand all</button>
                <button type="button" class="outline-toggle" data-outline-mode="collapsed" aria-pressed="false">Collapse all</button>
              </div>
              <label class="outline-search" for="outlineSearch">
                <span class="sr-only">Search document outline</span>
                <input type="search" id="outlineSearch" placeholder="Search sections" aria-label="Search document outline" autocomplete="off" />
                <button type="button" id="outlineSearchClear" aria-label="Clear outline search" hidden>&times;</button>
              </label>
            </div>
            <div class="entry-scroll" tabindex="0" aria-label="Active document sections">
              <div class="section-tree" id="entrySections">
              </div>
            </div>
          </div>
        </section>
      </div>
      <div class="workspace-gutter" data-between="doc" tabindex="0" role="separator" aria-orientation="vertical" aria-label="Resize active document and candidate panes"></div>
      <div class="workspace-pane candidate-pane" data-pane="candidates" data-pane-key="candidates">
        <section class="card pool-card">
          <div class="hd">
            <div>
              <div class="pane-title">Candidate pool</div>
              <div class="help" id="changeHelp">Loading changes…</div>
            </div>
            <div class="pane-controls">
              <button class="ghost" type="button" data-pane-max="candidates" aria-label="Maximize candidate pool" aria-pressed="false">Maximize</button>
            </div>
          </div>
          <div class="bd">
            <div class="candidate-list" id="candidatePoolList" role="list"></div>
            <div class="empty-state" id="candidatePoolEmpty" role="note">No candidates yet. Keep current text or add a proposal.</div>
          </div>
        </section>
        <section class="card queue-card">
          <div class="hd">
            <div class="pane-title">Waiting queue</div>
          </div>
          <div class="bd">
            <div class="queue-list" id="waitingQueueList" role="list"></div>
            <div class="empty-state" id="waitingQueueEmpty" role="note">Queue is empty for this section.</div>
          </div>
        </section>
        <section class="card history-card">
          <div class="hd">
            <div class="pane-title">History</div>
          </div>
          <div class="bd">
            <div class="list" id="historyList" role="list"></div>
            <div class="empty-state" id="historyEmpty" role="note">No history for this section yet.</div>
          </div>
        </section>
        <section class="card comments-card">
          <div class="hd">
            <div>
              <div class="pane-title">Discussion</div>
              <div class="help" id="commentTargetLabel">Select a section to view comments.</div>
            </div>
            <div class="pane-controls">
              <button class="ghost" type="button" id="commentScopeReset" hidden>Section discussion</button>
              <button class="ghost" type="button" id="commentRefreshBtn">Refresh</button>
            </div>
          </div>
          <div class="bd">
            <div id="commentList" class="comment-list" role="list"></div>
            <button type="button" class="ghost comment-load-more" id="commentLoadMore" hidden>Load older</button>
            <div class="comment-empty" id="commentEmpty" role="note">No comments yet. Be the first to share feedback.</div>
            <form id="commentForm" class="comment-form" data-has-membership="{% if project_membership %}1{% else %}0{% endif %}" aria-disabled="{% if project_membership %}false{% else %}true{% endif %}">
              <label class="sr-only" for="commentBody">New comment</label>
              <textarea id="commentBody" placeholder="Share feedback for this section" {% if not project_membership %}disabled{% endif %}></textarea>
              <div class="comment-form-actions">
                <button type="submit" class="primary" id="commentSubmitBtn">Post comment</button>
              </div>
            </form>
            <div class="comment-guest-note" id="commentGuestNote" {% if project_membership %}hidden{% endif %}>You need a project membership to participate in discussions.</div>
          </div>
        </section>
      </div>
      <div class="workspace-gutter" data-between="editor" tabindex="0" role="separator" aria-orientation="vertical" aria-label="Resize candidate and editor panes"></div>
      <div class="workspace-pane" data-pane="editor" data-pane-key="editor">
        <aside class="card composer-card">
          <div class="hd">
            <div>
              <div class="pane-title">Proposal editor</div>
              <div class="live-check-chip" id="liveChecksChip" aria-live="polite">Live checks: stable</div>
            </div>
            <div class="pane-controls">
              <button class="ghost" type="button" data-pane-max="editor" aria-label="Maximize proposal editor" aria-pressed="false">Maximize</button>
            </div>
          </div>
          <div class="bd">
            <div class="stack" id="composerArea"><div class="help">Select a section in the entry to propose edits, nested subsections, or moves.</div></div>
            <div class="stack" style="margin-top:10px">
              <label class="label" for="changeSummary">1‑line summary</label>
              <input id="changeSummary" placeholder="e.g., Improve wording" />
              <div class="stack" style="gap:6px;min-width:0;">
                <div class="row" style="gap:6px;flex-wrap:wrap;">
                  <span class="label">Section:</span>
                  <span id="sectionScope" class="tag section-scope">No section selected</span>
                </div>
                <div class="row anchor-controls" id="anchorRow" style="gap:6px;flex-wrap:wrap;align-items:center;display:none;">
                  <span class="label">After:</span>
                  <span id="anchorScope" class="tag anchor-scope">Document start</span>
                  <div class="row" style="gap:4px;">
                    <button class="ghost" type="button" data-anchor-shift="up">Move up</button>
                    <button class="ghost" type="button" data-anchor-shift="down">Move down</button>
                  </div>
                </div>
                <div class="row" style="gap:6px;flex-wrap:wrap;align-items:flex-start;">
                  <span class="label">Affects:</span>
                  <div id="affectsTags" class="row" style="flex-wrap:wrap;gap:6px"></div>
                </div>
              </div>
              <div class="composer-actions">
                <div class="row" style="gap:8px;flex-wrap:wrap;">
                  <button class="ghost" id="btnSaveDraft">Save draft</button>
                  <button class="ghost" id="btnClear">Clear</button>
                </div>
                <button class="primary" id="btnPublish" disabled>Submit to queue</button>
              </div>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </main>
  
  <!-- Debug bootstrap: safe, minimal logger to verify wiring before main script executes; also provides a functional fallback if main script fails to parse. -->
  <script>
    (function(){
      const themeKey='gmh_theme';
      const root=document.documentElement;
      const toggle=document.getElementById('themeToggle');
      const toggleLabel=document.getElementById('themeToggleLabel');
      const favicon=document.getElementById('siteFavicon');
      const navToggle=document.getElementById('navToggle');
      const headControls=document.getElementById('headControls');
      const applyTheme=(theme)=>{
        root.setAttribute('data-theme', theme);
        if(favicon){ favicon.href = theme==='dark' ? "{% static 'img/favicon-dark.png' %}" : "{% static 'img/favicon-light.png' %}"; }
        if(toggle){ toggle.setAttribute('aria-label', theme==='dark' ? 'Switch to light mode' : 'Switch to dark mode'); }
        if(toggleLabel){ toggleLabel.textContent = theme==='dark' ? 'Dark' : 'Light'; }
      };
      let storedTheme = localStorage.getItem(themeKey);
      if(!storedTheme){ storedTheme = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'; }
      applyTheme(storedTheme);
      if(toggle){
        toggle.addEventListener('click', ()=>{
          const next = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
          localStorage.setItem(themeKey, next);
          applyTheme(next);
        });
      }
      if(navToggle && headControls){
        navToggle.addEventListener('click', () => {
          const expanded = navToggle.getAttribute('aria-expanded') === 'true';
          const next = !expanded;
          navToggle.setAttribute('aria-expanded', next ? 'true' : 'false');
          headControls.dataset.expanded = next ? 'true' : 'false';
        });
      }

      if (!window.__gmhStartDraft) {
        window.__gmhStartDraft = function(sectionId){
          try { console.log('[GMH] stub __gmhStartDraft invoked with', sectionId); } catch(e) {}
          try {
            var scopeEl = document.getElementById('sectionScope');
            if (scopeEl) {
              scopeEl.textContent = String(sectionId);
              scopeEl.style.color = 'var(--text)';
              scopeEl.style.borderStyle = 'solid';
            }
          } catch(e) { try { console.warn('[GMH] stub failed to set scope', e); } catch(_) {} }
          return false;
        };
      }
    })();
  </script>

  <script src="{% static 'js/entry_detail.js' %}?v=20240919"></script>


  
</body>
</html>
