{% extends 'base.html' %}
{% block content %}
<div style="display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap;">
  <h1 style="margin:8px 0;">Projects</h1>
  <div style="display:flex;gap:8px;align-items:center;">
    <a href="/projects/new/" class="btn" style="padding:8px 12px;border:1px solid #333;border-radius:4px;">➕ New Project</a>
    <select id="projFilter" style="min-width:140px;">
      <option value="all">All</option>
      <option value="starred">Starred</option>
      <option value="active">Active</option>
    </select>
  </div>
</div>
<div class="card">
  {% if projects %}
  <table id="projectsTable">
    <thead>
      <tr>
        <th style="width:42px;">★</th>
        <th>Name</th>
        <th style="width:110px;">Activity</th>
        <th style="width:90px;">Stars</th>
        <th style="width:140px;">Created</th>
      </tr>
    </thead>
    <tbody>
      {% for p in projects %}
      <tr data-project-id="{{ p.id }}" data-activity="{{ p.activity }}" data-starred="{{ p.starred|yesno:'1,0' }}">
        <td>
          <button class="starBtn" data-starred="{{ p.starred|yesno:'1,0' }}" aria-label="Star project" style="background:none;border:none;font-size:16px;cursor:pointer;">
            {% if p.starred %}★{% else %}☆{% endif %}
          </button>
        </td>
        <td><a href="/projects/{{ p.id }}/">{{ p.name }}</a></td>
        <td><span class="muted" style="font-family:monospace;">{{ p.activity|floatformat:1 }}</span></td>
        <td><span class="starCount">{{ p.stars }}</span></td>
        <td>{{ p.created_at|date:'Y-m-d H:i' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p>No projects yet. <a href="/projects/new/">Create one</a>.</p>
  {% endif %}
</div>
{% endblock %}

<script>
(function(){
  const key='gmh_sim_user';
  const sim=localStorage.getItem(key)||'';
  const filterSel=document.getElementById('projFilter');
  const rows=[...document.querySelectorAll('#projectsTable tbody tr')];
  function applyFilter(){
    const f=filterSel.value;
    rows.forEach(r=>{
      const starred=r.getAttribute('data-starred')==='1';
      const activity=parseFloat(r.getAttribute('data-activity'))||0;
      let show=true;
      if(f==='starred' && !starred) show=false;
      if(f==='active' && activity<=0) show=false;
      r.style.display=show?'':'none';
    });
  }
  filterSel && filterSel.addEventListener('change', applyFilter);
  applyFilter();
  // Star toggling
  document.querySelectorAll('.starBtn').forEach(btn=>{
    btn.addEventListener('click', async (e)=>{
      e.preventDefault();
      const tr=btn.closest('tr');
      const pid=tr.getAttribute('data-project-id');
      const formData=new FormData();
      formData.append('sim_user', sim);
      try{
        const res=await fetch(`/api/projects/${pid}/star-toggle`, {method:'POST', body:formData});
        if(!res.ok) return;
        const data=await res.json();
        btn.dataset.starred=data.starred? '1':'0';
        tr.setAttribute('data-starred', data.starred? '1':'0');
        btn.textContent=data.starred? '★':'☆';
        tr.querySelector('.starCount').textContent=data.stars;
        applyFilter();
      }catch(err){console.error(err);}
    });
  });
})();
</script>
