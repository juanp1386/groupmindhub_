{% extends 'base.html' %}
{% block content %}
<div style="display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap;">
  <h1 style="margin:8px 0;">Projects</h1>
  <div style="display:flex;gap:8px;align-items:center;">
    <a href="/projects/new/" class="btn">➕ New Project</a>
    <select id="projFilter" style="min-width:140px;">
      <option value="all">All</option>
      <option value="starred">Starred</option>
      <option value="active">Active</option>
    </select>
  </div>
</div>
<div class="card">
  {% if projects %}
  <table id="projectsTable">
    <thead>
      <tr>
        <th style="width:42px;">★</th>
        <th>Name</th>
        <th style="width:110px;">Activity</th>
        <th style="width:90px;">Stars</th>
        <th style="width:140px;">Created</th>
      </tr>
    </thead>
    <tbody>
      {% for p in projects %}
      <tr data-project-id="{{ p.id }}" data-activity="{{ p.activity }}" data-starred="{{ p.starred|yesno:'1,0' }}">
        <td>
          <button class="starBtn" data-starred="{{ p.starred|yesno:'1,0' }}" aria-label="Star project" style="background:none;border:none;font-size:18px;cursor:pointer;color:inherit;">
            {% if p.starred %}★{% else %}☆{% endif %}
          </button>
        </td>
        <td><a href="/projects/{{ p.id }}/">{{ p.name }}</a></td>
        <td><span class="muted" style="font-family:monospace;">{{ p.activity|floatformat:1 }}</span></td>
        <td><span class="starCount">{{ p.stars }}</span></td>
        <td>{{ p.created_at|date:'Y-m-d H:i' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p>No projects yet. <a href="/projects/new/">Create one</a>.</p>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const filterSel=document.getElementById('projFilter');
  const table=document.getElementById('projectsTable');
  if(!filterSel || !table){return;}
  const rows=[...table.querySelectorAll('tbody tr')];

  function applyFilter(){
    const filter=filterSel.value;
    rows.forEach((row)=>{
      const starred=row.getAttribute('data-starred')==='1';
      const activity=parseFloat(row.getAttribute('data-activity'))||0;
      let visible=true;
      if(filter==='starred' && !starred){ visible=false; }
      if(filter==='active' && activity<=0){ visible=false; }
      row.style.display=visible? '':'none';
    });
  }

  filterSel.addEventListener('change', applyFilter);
  applyFilter();

  function getCookie(name){
    const parts=(document.cookie||'').split(';');
    for (let i=0;i<parts.length;i+=1){
      const cookie=parts[i].trim();
      if(!cookie) continue;
      if(cookie.startsWith(name+'=')){
        return decodeURIComponent(cookie.slice(name.length+1));
      }
    }
    return '';
  }

  const csrfToken=getCookie('csrftoken');

  table.querySelectorAll('.starBtn').forEach((btn)=>{
    btn.addEventListener('click', async (event)=>{
      event.preventDefault();
      const row=btn.closest('tr');
      if(!row){return;}
      const projectId=row.getAttribute('data-project-id');
      if(!projectId){return;}
      const formData=new FormData();
      try{
        const response=await fetch(`/api/projects/${projectId}/star-toggle`, {
          method:'POST',
          body:formData,
          headers: csrfToken ? {'X-CSRFToken': csrfToken} : {},
        });
        if(!response.ok){
          console.warn('Star toggle failed', response.status);
          return;
        }
        const data=await response.json();
        const starred=data.starred ? '1' : '0';
        btn.dataset.starred=starred;
        row.setAttribute('data-starred', starred);
        btn.textContent=data.starred ? '★' : '☆';
        const countEl=row.querySelector('.starCount');
        if(countEl){ countEl.textContent=data.stars; }
        applyFilter();
      }catch(error){
        console.error('Star toggle error', error);
      }
    });
  });
})();
</script>
{% endblock %}
