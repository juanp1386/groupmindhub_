{% extends 'base.html' %}
{% block content %}
<section class="project-create">
  <header class="page-head">
    <div>
      <h1>Create Project</h1>
      <p class="muted">Set up the baseline document structure your team will see on the entry page.</p>
    </div>
  </header>
  <form method="post" id="projectForm" class="project-form">{% csrf_token %}
    <input type="hidden" name="sections_json" id="sectionsJson" />
    <section class="project-card">
      <div class="field">
        <label for="projectName">Project name</label>
        <input id="projectName" name="name" required placeholder="e.g., Community Garden Bylaws" value="{{ request.POST.name|default:'' }}" />
      </div>
      <div class="field">
        <label for="projectDescription">Short description</label>
        <textarea id="projectDescription" name="description" rows="3" placeholder="What is this project about?">{{ request.POST.description|default:'' }}</textarea>
      </div>
      <div class="field">
        <label for="projectVisibility">Visibility</label>
        <select id="projectVisibility" name="visibility">
          <option value="public" selected>Public — anyone can view</option>
          <option value="private">Private — only invited members</option>
        </select>
      </div>
      <div class="field">
        <label for="projectInvites">Invite teammates</label>
        <textarea id="projectInvites" name="invite_emails" rows="3" placeholder="Add email addresses, one per line">{{ request.POST.invite_emails|default:'' }}</textarea>
        <small class="muted">We’ll generate shareable invite links and send them from the settings page.</small>
      </div>
      <div class="field">
        <label for="projectInviteRole">Default invite role</label>
        <select id="projectInviteRole" name="invite_role">
          <option value="viewer" selected>Viewer</option>
          <option value="editor">Editor</option>
        </select>
      </div>
      <div class="field-set">
        <div class="field">
          <h3>Governance</h3>
          <p class="muted">Define how proposals are evaluated. Defaults can be adjusted later from Settings.</p>
        </div>
        <div class="field-grid">
          <div class="field">
            {{ governance_form.voting_pool_size.label_tag }}
            {{ governance_form.voting_pool_size }}
            {% if governance_form.voting_pool_size.help_text %}
            <small class="muted">{{ governance_form.voting_pool_size.help_text }}</small>
            {% endif %}
            {% if governance_form.voting_pool_size.errors %}
            <div class="form-error">{{ governance_form.voting_pool_size.errors|join:', ' }}</div>
            {% endif %}
          </div>
          <div class="field">
            {{ governance_form.approval_threshold.label_tag }}
            {{ governance_form.approval_threshold }}
            {% if governance_form.approval_threshold.help_text %}
            <small class="muted">{{ governance_form.approval_threshold.help_text }}</small>
            {% endif %}
            {% if governance_form.approval_threshold.errors %}
            <div class="form-error">{{ governance_form.approval_threshold.errors|join:', ' }}</div>
            {% endif %}
          </div>
          <div class="field">
            {{ governance_form.voting_duration_hours.label_tag }}
            {{ governance_form.voting_duration_hours }}
            {% if governance_form.voting_duration_hours.help_text %}
            <small class="muted">{{ governance_form.voting_duration_hours.help_text }}</small>
            {% endif %}
            {% if governance_form.voting_duration_hours.errors %}
            <div class="form-error">{{ governance_form.voting_duration_hours.errors|join:', ' }}</div>
            {% endif %}
          </div>
        </div>
      </div>
    </section>
    <section class="project-doc">
      <div class="doc-head">
        <div>
          <h2>Entry outline</h2>
          <p class="muted">Use the inline fields to sketch the sections that will appear in the initial document.</p>
        </div>
        <button type="button" class="ghost" data-add-root>Add top-level section</button>
      </div>
      <div class="doc-body">
        <div id="sectionsContainer" class="section-tree builder-tree"></div>
      </div>
    </section>
    <div class="form-actions">
      <button type="button" class="ghost" data-add-root>Add another section</button>
      <button class="primary">Create project</button>
    </div>
  </form>
</section>
<script>
(function(){
  const container=document.getElementById('sectionsContainer');
  const addRootButtons=Array.from(document.querySelectorAll('[data-add-root]'));
  if(!container){ console.warn('Section builder init skipped (elements missing)'); return; }

  const sections=[];
  let pendingHighlightPath=null;

  const uuid=()=> (window.crypto && window.crypto.randomUUID ? window.crypto.randomUUID() : `tmp_${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`);
  const escapeHtml=(s='')=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');

  function ensureChildren(node){
    if(!Array.isArray(node.children)){ node.children=[]; }
  }

  function newSection(){
    return { id: uuid(), heading: '', body: '', children: [] };
  }

  function getContext(path){
    let list=sections;
    let node=null;
    for(let i=0;i<path.length;i+=1){
      const idx=path[i];
      node=list[idx];
      if(node===undefined){
        return { list:null, index:null, node:null };
      }
      if(i===path.length-1){
        return { list, index:idx, node };
      }
      ensureChildren(node);
      list=node.children;
    }
    return { list:sections, index:null, node:null };
  }

  const numberingFromPath=(path)=>path.map((i)=>i+1).join('.');

  function renderList(list, pathPrefix, depth, frag){
    list.forEach((section, idx)=>{
      ensureChildren(section);
      const path=pathPrefix.concat(idx);
      const depthLevel=depth+1;
      const number=numberingFromPath(path);
      const node=document.createElement('div');
      node.className=`section-node depth-${depthLevel} builder-section`;
      node.setAttribute('data-path', path.join('|'));
      node.innerHTML=`<div class="section-header builder-header">
          <div class="builder-heading-row">
            <span class="builder-number">${number}</span>
            <input class="builder-heading-input" data-field="heading" value="${escapeHtml(section.heading)}" placeholder="Untitled section" aria-label="Heading for section ${number}" />
          </div>
          <div class="section-actions builder-actions">
            <button type="button" class="builder-action" data-act="insert-below">Add below</button>
            <button type="button" class="builder-action" data-act="add-child">Add subsection</button>
            <button type="button" class="builder-action" data-act="up" ${idx===0?'disabled':''}>Move up</button>
            <button type="button" class="builder-action" data-act="down" ${idx===list.length-1?'disabled':''}>Move down</button>
            <button type="button" class="builder-action danger" data-act="remove">Remove</button>
          </div>
        </div>
        <div class="section-body builder-body">
          <textarea class="builder-textarea" data-field="body" placeholder="Body (optional)" aria-label="Body for section ${number}">${escapeHtml(section.body)}</textarea>
        </div>`;
      node.querySelectorAll('[data-field]').forEach((input)=>{
        input.addEventListener('input',()=>{
          const field=input.getAttribute('data-field');
          section[field]=input.value;
        });
      });
      node.querySelectorAll('button[data-act]').forEach((btn)=>{
        btn.addEventListener('click',()=>{
          const context=getContext(path);
          const ctxList=context.list;
          const index=context.index;
          if(!ctxList||index===null){return;}
          const act=btn.getAttribute('data-act');
          if(act==='remove'){
            ctxList.splice(index,1);
          }else if(act==='up' && index>0){
            [ctxList[index-1],ctxList[index]]=[ctxList[index],ctxList[index-1]];
          }else if(act==='down' && index<ctxList.length-1){
            [ctxList[index+1],ctxList[index]]=[ctxList[index],ctxList[index+1]];
          }else if(act==='add-child'){
            ensureChildren(section);
            const child=newSection();
            section.children.push(child);
            pendingHighlightPath=path.concat(section.children.length-1).join('|');
          }else if(act==='insert-below'){
            const sibling=newSection();
            ctxList.splice(index+1,0,sibling);
            const nextPath=path.slice(0,-1);
            nextPath.push(index+1);
            pendingHighlightPath=nextPath.join('|');
          }
          render();
        });
      });
      frag.appendChild(node);
      if(section.children.length){
        renderList(section.children,path,depthLevel,frag);
      }
    });
  }

  function render(){
    container.innerHTML='';
    if(sections.length===0){
      const empty=document.createElement('div');
      empty.className='builder-empty';
      empty.innerHTML='<strong>No sections yet.</strong><br />Use "Add top-level section" to start the outline.';
      container.appendChild(empty);
      return;
    }
    const frag=document.createDocumentFragment();
    renderList(sections,[],0,frag);
    container.appendChild(frag);
    if(pendingHighlightPath){
    const target=container.querySelector(`[data-path="${pendingHighlightPath}"]`);
      if(target){
        target.classList.add('is-new');
        target.scrollIntoView({behavior:'smooth',block:'center'});
        window.setTimeout(()=>{target.classList.remove('is-new');},900);
      }
      pendingHighlightPath=null;
    }
  }

  function addRootSection(){
    const index=sections.push(newSection())-1;
    pendingHighlightPath=String(index);
    render();
  }

  addRootButtons.forEach((btn)=>{
    btn.addEventListener('click',addRootSection);
  });

  const form=document.getElementById('projectForm');
  const sectionsField=document.getElementById('sectionsJson');
  if(form&&sectionsField){
    form.addEventListener('submit',()=>{
      sectionsField.value=JSON.stringify(sections);
    });
  }

  sections.push({id:uuid(),heading:'Purpose',body:'',children:[]});
  render();
})();
</script>
<style>
.project-create{display:flex;flex-direction:column;gap:24px;margin-bottom:48px;}
.page-head{display:flex;justify-content:space-between;align-items:flex-start;gap:24px;}
.page-head h1{margin:0;font-size:28px;}
.page-head p{margin:6px 0 0;max-width:520px;font-size:13px;}
.project-form{display:flex;flex-direction:column;gap:24px;max-width:960px;}
.project-card{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:24px 28px;box-shadow:0 18px 42px var(--shadow);background-image:var(--grain-pattern);background-blend-mode:overlay;}
.project-card .field{display:flex;flex-direction:column;gap:6px;margin-top:18px;}
.project-card .field:first-of-type{margin-top:0;}
.project-card .field-set{margin-top:24px;padding-top:18px;border-top:1px solid rgba(var(--accent-rgb),0.2);}
.project-card .field-set h3{margin:0;font-size:16px;}
.project-card .field-set p{margin:6px 0 0;font-size:13px;}
.field-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:18px;margin-top:12px;}
.governance-input{width:100%;background:transparent;border-radius:12px;padding:10px 12px;border:1px solid rgba(var(--accent-rgb),0.3);}
.governance-input:focus{border-color:rgba(var(--accent-rgb),0.6);outline:0;}
.project-card label{font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);}
.project-card input,
.project-card textarea{width:100%;background:transparent;border-radius:12px;padding:12px 14px;border:1px solid rgba(var(--accent-rgb),0.3);}
.project-card textarea{min-height:80px;resize:vertical;}
.project-card input:focus,
.project-card textarea:focus{border-color:rgba(var(--accent-rgb),0.6);background:rgba(var(--accent-rgb),0.12);outline:0;}

.project-doc{border:1px solid var(--border);border-radius:22px;background:rgba(255,255,255,0.65);box-shadow:0 28px 48px var(--shadow);overflow:hidden;background-image:var(--grain-pattern);background-blend-mode:overlay;}
[data-theme='dark'] .project-doc{background:rgba(15,27,30,0.9);border-color:rgba(255,255,255,0.1);}
.doc-head{display:flex;justify-content:space-between;align-items:flex-start;gap:24px;padding:24px 28px;border-bottom:1px solid rgba(0,0,0,0.06);}
[data-theme='dark'] .doc-head{border-color:rgba(255,255,255,0.08);}
.doc-head h2{margin:0;font-size:20px;}
.doc-head p{margin:6px 0 0;color:var(--muted);font-size:13px;max-width:520px;}
.doc-body{padding:0;}

.section-tree.builder-tree{display:flex;flex-direction:column;}
.section-tree.builder-tree>.builder-section:first-child{border-top:1px solid rgba(0,0,0,0.08);}
[data-theme='dark'] .section-tree.builder-tree>.builder-section:first-child{border-top-color:rgba(255,255,255,0.12);}

[data-theme='dark'] .section-tree.builder-tree>.builder-section:first-child{border-top-color:rgba(255,255,255,0.12);}

.builder-section{padding:10px 24px 12px;border-bottom:1px solid rgba(0,0,0,0.08);background:rgba(255,255,255,0.55);transition:background .2s ease,box-shadow .2s ease;background-image:var(--grain-pattern);background-blend-mode:overlay;}
[data-theme='dark'] .builder-section{background:rgba(17,30,34,0.85);border-bottom-color:rgba(255,255,255,0.12);}
.builder-section.depth-1{padding-left:24px;}
.builder-section.depth-2{padding-left:46px;}
.builder-section.depth-3{padding-left:64px;}
.builder-section.depth-4{padding-left:82px;}
.builder-section.depth-5{padding-left:100px;}
.builder-section.depth-6{padding-left:118px;}
.builder-section.is-new{background:rgba(var(--accent-rgb),0.18);box-shadow:inset 3px 0 0 rgba(var(--accent-rgb),0.55);background-image:var(--grain-pattern);background-blend-mode:overlay;}

.builder-header{align-items:flex-start;margin-bottom:4px;}
.builder-heading-row{display:flex;align-items:center;gap:10px;flex:1;}
.builder-number{display:inline-flex;align-items:center;justify-content:center;min-width:36px;height:24px;border-radius:999px;background:rgba(var(--accent-rgb),0.18);color:var(--accent);font-size:11px;font-weight:600;letter-spacing:.06em;text-transform:uppercase;}
[data-theme='dark'] .builder-number{background:rgba(var(--accent-rgb),0.32);color:var(--text);}
.builder-heading-input{flex:1;border:1px solid transparent;border-radius:8px;padding:6px 10px;font-size:14px;font-weight:600;background:rgba(255,255,255,0.65);color:var(--text);transition:border .2s ease,background .2s ease;}
[data-theme='dark'] .builder-heading-input{background:rgba(20,33,36,0.9);}
.builder-heading-input::placeholder{color:rgba(var(--accent-rgb),0.5);}
.builder-heading-input:focus{border-color:rgba(var(--accent-rgb),0.55);background:rgba(var(--accent-rgb),0.12);outline:0;}

.builder-body{padding:0;margin-top:4px;}
.builder-textarea{width:100%;min-height:64px;border-radius:10px;border:1px dashed rgba(var(--accent-rgb),0.26);padding:8px 12px;background:rgba(255,255,255,0.55);color:var(--text);font-size:13px;line-height:1.58;resize:vertical;transition:border .2s ease,background .2s ease;background-image:var(--grain-pattern);background-blend-mode:overlay;}
.builder-textarea:focus{border-color:rgba(var(--accent-rgb),0.58);background:rgba(var(--accent-rgb),0.14);outline:0;}
[data-theme='dark'] .builder-textarea{background:rgba(20,33,36,0.92);border-color:rgba(255,255,255,0.18);}

.builder-actions{display:flex;gap:4px;flex-wrap:wrap;margin-top:0;}
.builder-action{border:1px solid rgba(var(--accent-rgb),0.32);background:transparent;color:var(--muted);padding:3px 8px;border-radius:999px;font-size:10px;text-transform:uppercase;letter-spacing:.07em;}
.builder-action:hover{border-color:rgba(var(--accent-rgb),0.6);color:var(--accent);}
.builder-action.danger{border-color:rgba(236,120,120,0.55);color:#c96f6f;}
.builder-action.danger:hover{border-color:rgba(236,120,120,0.75);color:#f08d8d;}
.builder-action[disabled]{opacity:0.4;pointer-events:none;}

.builder-empty{padding:42px 28px;margin:24px;border:2px dashed rgba(var(--accent-rgb),0.35);border-radius:18px;background:rgba(255,255,255,0.55);font-size:13px;color:var(--muted);text-align:center;background-image:var(--grain-pattern);background-blend-mode:overlay;}
[data-theme='dark'] .builder-empty{background:rgba(17,30,34,0.88);border-color:rgba(255,255,255,0.18);color:rgba(244,248,247,0.8);}

.form-actions{display:flex;gap:12px;align-items:center;justify-content:flex-end;}
.form-actions .primary{min-width:200px;}
.form-actions .ghost{font-size:12px;}

@media (max-width:900px){
  .project-form{max-width:100%;}
  .builder-section.depth-2{padding-left:40px;}
  .builder-section.depth-3{padding-left:52px;}
  .builder-section.depth-4{padding-left:64px;}
  .builder-section.depth-5{padding-left:76px;}
  .builder-section.depth-6{padding-left:88px;}
}
</style>
{% endblock %}
